.PHONY: help install start stop restart logs clean build seed status test-api shell-backend shell-frontend db-reset

# Colors for output
BLUE := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

# Default target - show help
help:
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(BLUE)â•‘        SkillBridge AI - Docker Management Commands        â•‘$(RESET)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(GREEN)Quick Start:$(RESET)"
	@echo "  $(YELLOW)make start$(RESET)        - Start all services (database, backend, frontend)"
	@echo "  $(YELLOW)make stop$(RESET)         - Stop all services"
	@echo "  $(YELLOW)make logs$(RESET)         - View all service logs"
	@echo ""
	@echo "$(GREEN)Setup Commands:$(RESET)"
	@echo "  $(YELLOW)make install$(RESET)      - Install Docker if not present"
	@echo "  $(YELLOW)make build$(RESET)        - Build Docker images"
	@echo "  $(YELLOW)make seed$(RESET)         - Import real data from Excel files"
	@echo "  $(YELLOW)make db-reset$(RESET)     - Reset database and re-import data"
	@echo ""
	@echo "$(GREEN)Management Commands:$(RESET)"
	@echo "  $(YELLOW)make restart$(RESET)      - Restart all services"
	@echo "  $(YELLOW)make status$(RESET)       - Check status of all containers"
	@echo "  $(YELLOW)make clean$(RESET)        - Stop and remove all containers + volumes"
	@echo ""
	@echo "$(GREEN)Development Commands:$(RESET)"
	@echo "  $(YELLOW)make logs-backend$(RESET) - View backend logs only"
	@echo "  $(YELLOW)make logs-frontend$(RESET) - View frontend logs only"
	@echo "  $(YELLOW)make shell-backend$(RESET) - Open shell in backend container"
	@echo "  $(YELLOW)make shell-frontend$(RESET) - Open shell in frontend container"
	@echo "  $(YELLOW)make test-api$(RESET)     - Test backend API endpoints"
	@echo ""
	@echo "$(GREEN)Access Points:$(RESET)"
	@echo "  Frontend:  $(BLUE)http://localhost:8080$(RESET)"
	@echo "  Backend:   $(BLUE)http://localhost:3000$(RESET)"
	@echo "  Login:     $(BLUE)http://localhost:8080/login$(RESET)"
	@echo ""
	@echo "$(GREEN)Login Credentials:$(RESET)"
	@echo "  Manager:   $(YELLOW)karel.vagner@skoda.cz$(RESET) / password123"
	@echo "  Employee:  $(YELLOW)martin.svoboda@skoda.cz$(RESET) / password123"
	@echo ""

# Install Docker (macOS only)
install:
	@echo "$(BLUE)ğŸ“¦ Installing Docker Desktop...$(RESET)"
	@if command -v brew >/dev/null 2>&1; then \
		brew install --cask docker; \
		echo "$(GREEN)âœ… Docker installed! Please start Docker Desktop from Applications$(RESET)"; \
	else \
		echo "$(RED)âŒ Homebrew not found. Install from: https://brew.sh$(RESET)"; \
		exit 1; \
	fi

# Start all services
start:
	@echo "$(BLUE)ğŸš€ Starting SkillBridge AI...$(RESET)"
	@if ! docker info > /dev/null 2>&1; then \
		echo "$(RED)âŒ Docker is not running. Please start Docker Desktop first.$(RESET)"; \
		exit 1; \
	fi
	@docker-compose up -d
	@echo ""
	@echo "$(GREEN)âœ… Services started!$(RESET)"
	@echo ""
	@echo "$(YELLOW)â³ Waiting for services to be ready...$(RESET)"
	@sleep 5
	@$(MAKE) status
	@echo ""
	@echo "$(GREEN)ğŸŒ Access your application:$(RESET)"
	@echo "   Frontend: $(BLUE)http://localhost:8080$(RESET)"
	@echo "   Login:    $(BLUE)http://localhost:8080/login$(RESET)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¡ Run 'make seed' to import real data from Excel files$(RESET)"
	@echo "$(YELLOW)ğŸ’¡ Run 'make logs' to view service logs$(RESET)"

# Build Docker images
build:
	@echo "$(BLUE)ğŸ”¨ Building Docker images...$(RESET)"
	@docker-compose build
	@echo "$(GREEN)âœ… Build complete!$(RESET)"

# Stop all services
stop:
	@echo "$(BLUE)ğŸ›‘ Stopping services...$(RESET)"
	@docker-compose down
	@echo "$(GREEN)âœ… All services stopped$(RESET)"

# Restart all services
restart:
	@echo "$(BLUE)ğŸ”„ Restarting services...$(RESET)"
	@docker-compose restart
	@echo "$(GREEN)âœ… Services restarted$(RESET)"

# View logs
logs:
	@docker-compose logs -f

logs-backend:
	@docker-compose logs -f backend

logs-frontend:
	@docker-compose logs -f frontend

logs-postgres:
	@docker-compose logs -f postgres

# Clean everything (remove containers and volumes)
clean:
	@echo "$(RED)ğŸ§¹ Cleaning up Docker containers and volumes...$(RESET)"
	@docker-compose down -v
	@echo "$(GREEN)âœ… Cleanup complete$(RESET)"

# Import real data from Excel files
seed:
	@echo "$(BLUE)ğŸ“Š Importing real dataset from Excel files...$(RESET)"
	@docker-compose exec -T backend npm run db:seed:real
	@echo ""
	@echo "$(GREEN)âœ… Data import complete!$(RESET)"
	@echo ""
	@echo "$(GREEN)ğŸ” Login credentials:$(RESET)"
	@echo "   Manager:  $(YELLOW)karel.vagner@skoda.cz$(RESET) / password123"
	@echo "   Employee: $(YELLOW)martin.svoboda@skoda.cz$(RESET) / password123"

# Reset database and re-import data
db-reset:
	@echo "$(YELLOW)ğŸ”„ Resetting database...$(RESET)"
	@docker-compose exec -T backend npx prisma migrate reset --force
	@$(MAKE) seed

# Check status of containers
status:
	@echo "$(BLUE)ğŸ“Š Container Status:$(RESET)"
	@docker-compose ps

# Test API endpoints
test-api:
	@echo "$(BLUE)ğŸ§ª Testing Backend API...$(RESET)"
	@echo ""
	@echo "$(YELLOW)Testing Manager Login:$(RESET)"
	@curl -s -X POST http://localhost:3000/api/auth/login \
		-H "Content-Type: application/json" \
		-d '{"email":"karel.vagner@skoda.cz","password":"password123"}' | \
		grep -o '"token":"[^"]*"' && echo " $(GREEN)âœ…$(RESET)" || echo " $(RED)âŒ$(RESET)"
	@echo ""
	@echo "$(YELLOW)Testing Employee Login:$(RESET)"
	@curl -s -X POST http://localhost:3000/api/auth/login \
		-H "Content-Type: application/json" \
		-d '{"email":"martin.svoboda@skoda.cz","password":"password123"}' | \
		grep -o '"token":"[^"]*"' && echo " $(GREEN)âœ…$(RESET)" || echo " $(RED)âŒ$(RESET)"
	@echo ""

# Run full CI tests (like in GitHub Actions)
test-ci:
	@echo "$(BLUE)ğŸ§ª Running CI Test Suite...$(RESET)"
	@./test-ci.sh

# Open shell in backend container
shell-backend:
	@docker-compose exec backend sh

# Open shell in frontend container
shell-frontend:
	@docker-compose exec frontend sh

# Open Prisma Studio
prisma-studio:
	@echo "$(BLUE)ğŸ¨ Opening Prisma Studio...$(RESET)"
	@docker-compose exec backend npx prisma studio

# Check database users
db-users:
	@echo "$(BLUE)ğŸ‘¥ Users in database:$(RESET)"
	@docker-compose exec -T backend node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.user.findMany({ select: { email: true, firstName: true, lastName: true, role: true }, take: 15 }).then(users => { console.log('\nTotal users:', users.length); users.forEach(u => console.log('  ğŸ“§', u.email, '(' + u.role + ')')); prisma.\$$disconnect(); });"

# Full setup from scratch
setup: clean build start seed
	@echo ""
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(GREEN)â•‘          ğŸ‰ Setup Complete! Ready to use! ğŸ‰              â•‘$(RESET)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(GREEN)ğŸŒ Open in browser:$(RESET) $(BLUE)http://localhost:8080/login$(RESET)"
	@echo ""
	@echo "$(GREEN)ğŸ” Login credentials:$(RESET)"
	@echo "   Manager:  $(YELLOW)karel.vagner@skoda.cz$(RESET) / password123"
	@echo "   Employee: $(YELLOW)martin.svoboda@skoda.cz$(RESET) / password123"
	@echo ""
